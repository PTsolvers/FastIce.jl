steps:
  - label: "CUDA Julia {{matrix.version}}"
    matrix:
      setup:
        version:
          - "1.9"
    plugins:
      - JuliaCI/julia#v1:
          version: "{{matrix.version}}"
      - JuliaCI/julia-coverage#v1:
          codecov: true
    command: |
      julia -e 'println("--- :julia: Instantiating project")
                using Pkg
                Pkg.develop(; path=pwd())
                Pkg.develop(; name="CUDA")' || exit 3

      julia -e 'println("+++ :julia: Running tests")
                using Pkg
                Pkg.test("FastIce"; coverage=true)'
    agents:
      queue: "juliagpu"
      cuda: "*"
    timeout_in_minutes: 120
    soft_fail:
      - exit_status: 3

  - label: "AMDGPU Julia {{matrix.version}}"
    matrix:
      setup:
        version:
          - "1.9"
    plugins:
      - JuliaCI/julia#v1:
          version: "{{matrix.version}}"
      - JuliaCI/julia-coverage#v1:
          codecov: true
    command: |
      julia -e 'println("--- :julia: Instantiating project")
                using Pkg
                Pkg.develop(; path=pwd())
                Pkg.develop(; name="AMDGPU")' || exit 3

      julia -e 'println("+++ :julia: Running tests")
                using Pkg
                Pkg.test("FastIce"; coverage=true)'
    agents:
      queue: "juliagpu"
      rocm: "*"
    timeout_in_minutes: 120
    soft_fail:
      - exit_status: 3
    env:
      JULIA_NUM_THREADS: 4
env:
  SECRET_CODECOV_TOKEN: "h7xtShnw5iYNdl2NRu+3vSZhouxpHnlUN1hk3S3+rgb20FSaUJNllybEKDViGRlxRL3QcfqKAAuVW+5Oh+ZJMxA6y42jBNdkZXZFs9Dkq2nQBqoTV9FlCpPIWttsQDjieA+GvwzdCJ1R1w/wno/CNIIJRKwB1dsE8+Jd5E7XK42qqlp+93ZFD95PjhuWyn4YfhYXicmnK9yOBl09WiCsUJ0wQZmgPC7PkizK2C1HcAsOdlKkRzJJXXColBw4aEZrOoXZs4jBKJNqK1vYDlYIJluChGmqLVKdj0+bjhWEZTqrud2CHG3aOZor83l/Vnf7v1Pj4OJ7oQBu11W559sbfQ==;U2FsdGVkX19W87skiyuIzL6WudS0PgA7p9tP8G/RK08+rAekIXHKrAP8cfGTBJiTwSLA+B0eNnpOyTIQ7F5CSZCu3jNkCbg9yotK11nFg+4="