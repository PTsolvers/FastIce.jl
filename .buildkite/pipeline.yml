steps:
  - label: "CUDA Julia {{matrix.version}}"
    matrix:
      setup:
        version:
          - "1.9"
    plugins:
      - JuliaCI/julia#v1:
          version: "{{matrix.version}}"
      - JuliaCI/julia-coverage#v1:
          codecov: true
    command: |
      julia -e 'println("--- :julia: Instantiating project")
                using Pkg
                Pkg.develop(; path=pwd())
                Pkg.develop(; name="CUDA")' || exit 3

      julia -e 'println("+++ :julia: Running tests")
                using Pkg
                Pkg.test("FastIce")'
    agents:
      queue: "juliagpu"
      cuda: "*"
    timeout_in_minutes: 120
    soft_fail:
      - exit_status: 3

  - label: "AMDGPU Julia {{matrix.version}}"
    matrix:
      setup:
        version:
          - "1.9"
    plugins:
      - JuliaCI/julia#v1:
          version: "{{matrix.version}}"
      - JuliaCI/julia-coverage#v1:
          codecov: true
    command: |
      julia -e 'println("--- :julia: Instantiating project")
                using Pkg
                Pkg.develop(; path=pwd())
                Pkg.develop(; name="AMDGPU")' || exit 3

      julia -e 'println("+++ :julia: Running tests")
                using Pkg
                Pkg.test("FastIce")'
    agents:
      queue: "juliagpu"
      rocm: "*"
    timeout_in_minutes: 120
    soft_fail:
      - exit_status: 3
    env:
      JULIA_NUM_THREADS: 4
env:
  JULIA_PKG_SERVER: "" # it often struggles with our large artifacts
  SECRET_CODECOV_TOKEN: "U3LESDIqXNQtxUp/m+ksB4mhQcJK41PgeVR4YJ7qVTL+ILi9k1QZK/Ah23BP+JakY1z1KCRi9tgRguGMiNAEsCio22iv+T0RmBlQeK/nme/35LDAcDgjLbixg1iQ/ILBKDNL3Sg6kR1A+1n/WWkuE87Z6skWO2WHYK+uVyMuloDHEtWrHJanGeEcbs0xh+JhVePjUkIFmVMnLB/zO1S9CUH5V/VwgV4IEoVMxoqOfI9xDgPkxIqjot0lclMTSiA2+cr2jIblmfJ9DLfuJ6zy7gjwuY/lfS7+mwSaXTRJG56QJe/YRrnl4s/fNJQDJ59glV0t/x3St9R4IgG3S6s8Ig==;U2FsdGVkX198ataYAQN8ZtE5OixQCItn4JpAwW6Qyai2XoYdGotZYj/9sLWDCdQKB2KXTTcKgU3tZvEaWoiPLQ=="